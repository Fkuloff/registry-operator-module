// Package vulnerability provides vulnerability scanning functionality using Trivy.
package vulnerability

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"os/exec"
	"slices"
	"time"

	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"

	"registry-operator/apis/registry.kubecontroller.io/v1alpha1"
)

// Default configuration values for Trivy scanner.
const (
	_defaultTimeout           = 5 * time.Minute
	_defaultSeverityThreshold = "MEDIUM"
	_defaultTopCVEsLimit      = 10
	_maxTitleLength           = 100
)

// Scanner defines the interface for vulnerability scanning implementations.
type Scanner interface {
	Scan(ctx context.Context, imageRef string) (*v1alpha1.VulnerabilitySummary, error)
}

// Verify TrivyScanner implements Scanner interface.
var _ Scanner = (*TrivyScanner)(nil)

// TrivyScanner implements vulnerability scanning using Trivy CLI.
type TrivyScanner struct {
	severityThreshold string
	ignoreUnfixed     bool
	timeout           time.Duration
}

// TrivyConfig holds configuration options for the Trivy scanner.
type TrivyConfig struct {
	SeverityThreshold string
	IgnoreUnfixed     bool
	Timeout           time.Duration
}

// NewTrivyScanner creates a new Trivy-based vulnerability scanner.
func NewTrivyScanner(cfg TrivyConfig) *TrivyScanner {
	s := &TrivyScanner{
		severityThreshold: cfg.SeverityThreshold,
		ignoreUnfixed:     cfg.IgnoreUnfixed,
		timeout:           cfg.Timeout,
	}

	if s.timeout == 0 {
		s.timeout = _defaultTimeout
	}
	if s.severityThreshold == "" {
		s.severityThreshold = _defaultSeverityThreshold
	}

	return s
}

// trivyOutput represents the root JSON structure from Trivy.
type trivyOutput struct {
	Results []trivyResult `json:"Results"`
}

// trivyResult represents a single target scan result from Trivy.
type trivyResult struct {
	Target          string               `json:"Target"`
	Vulnerabilities []trivyVulnerability `json:"Vulnerabilities"`
}

// trivyVulnerability represents a single vulnerability from Trivy output.
type trivyVulnerability struct {
	VulnerabilityID  string `json:"VulnerabilityID"`
	PkgName          string `json:"PkgName"`
	InstalledVersion string `json:"InstalledVersion"`
	FixedVersion     string `json:"FixedVersion"`
	Severity         string `json:"Severity"`
	Title            string `json:"Title"`
}

// Scan executes trivy image scan and returns a vulnerability summary.
func (s *TrivyScanner) Scan(ctx context.Context, imageRef string) (*v1alpha1.VulnerabilitySummary, error) {
	args := []string{
		"image",
		"--format", "json",
		"--quiet",
		"--severity", s.getSeverityFilter(),
	}

	if s.ignoreUnfixed {
		args = append(args, "--ignore-unfixed")
	}

	args = append(args, imageRef)

	ctx, cancel := context.WithTimeout(ctx, s.timeout)
	defer cancel()

	cmd := exec.CommandContext(ctx, "trivy", args...)

	var stdout, stderr bytes.Buffer
	cmd.Stdout = &stdout
	cmd.Stderr = &stderr

	if err := cmd.Run(); err != nil {
		if ctx.Err() == context.DeadlineExceeded {
			return nil, fmt.Errorf("trivy scan timeout after %v", s.timeout)
		}
		return nil, fmt.Errorf("trivy scan: %w, stderr: %s", err, stderr.String())
	}

	return s.parseOutput(stdout.Bytes())
}

// severityFilters maps threshold to trivy severity argument.
var _severityFilters = map[string]string{
	"CRITICAL": "CRITICAL",
	"HIGH":     "CRITICAL,HIGH",
	"MEDIUM":   "CRITICAL,HIGH,MEDIUM",
	"LOW":      "CRITICAL,HIGH,MEDIUM,LOW",
}

// getSeverityFilter returns the trivy severity argument based on threshold.
func (s *TrivyScanner) getSeverityFilter() string {
	if filter, ok := _severityFilters[s.severityThreshold]; ok {
		return filter
	}
	return "CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN"
}

// parseOutput converts trivy JSON output into VulnerabilitySummary.
func (s *TrivyScanner) parseOutput(data []byte) (*v1alpha1.VulnerabilitySummary, error) {
	var output trivyOutput
	if err := json.Unmarshal(data, &output); err != nil {
		return nil, fmt.Errorf("parse trivy output: %w", err)
	}

	now := metav1.Now()
	summary := &v1alpha1.VulnerabilitySummary{
		LastScanTime: &now,
	}

	var allVulns []trivyVulnerability

	for _, result := range output.Results {
		for _, vuln := range result.Vulnerabilities {
			allVulns = append(allVulns, vuln)

			switch vuln.Severity {
			case "CRITICAL":
				summary.Critical++
			case "HIGH":
				summary.High++
			case "MEDIUM":
				summary.Medium++
			case "LOW":
				summary.Low++
			default:
				summary.Unknown++
			}
		}
	}

	summary.Total = len(allVulns)
	summary.TopCVEs = s.getTopCVEs(allVulns, _defaultTopCVEsLimit)

	return summary, nil
}

// severityPriorities maps severity to sort priority (lower is more severe).
var _severityPriorities = map[string]int{
	"CRITICAL": 0,
	"HIGH":     1,
	"MEDIUM":   2,
	"LOW":      3,
}

// getTopCVEs extracts the most critical CVEs from the scan results.
func (s *TrivyScanner) getTopCVEs(vulns []trivyVulnerability, limit int) []v1alpha1.CVEInfo {
	slices.SortFunc(vulns, func(a, b trivyVulnerability) int {
		pa := _severityPriorities[a.Severity]
		pb := _severityPriorities[b.Severity]
		if pa != pb {
			return pa - pb
		}
		return 0
	})

	var topCVEs []v1alpha1.CVEInfo
	seen := make(map[string]struct{})

	for _, vuln := range vulns {
		if _, ok := seen[vuln.VulnerabilityID]; ok {
			continue
		}
		seen[vuln.VulnerabilityID] = struct{}{}

		if vuln.Severity != "CRITICAL" && vuln.Severity != "HIGH" {
			continue
		}

		topCVEs = append(topCVEs, v1alpha1.CVEInfo{
			ID:               vuln.VulnerabilityID,
			Severity:         vuln.Severity,
			Package:          vuln.PkgName,
			InstalledVersion: vuln.InstalledVersion,
			FixedVersion:     vuln.FixedVersion,
			Title:            truncateString(vuln.Title, _maxTitleLength),
		})

		if len(topCVEs) >= limit {
			break
		}
	}

	return topCVEs
}

// truncateString limits string length, adding ellipsis if truncated.
func truncateString(s string, maxLen int) string {
	if len(s) <= maxLen {
		return s
	}
	return s[:maxLen-3] + "..."
}

// CheckTrivyInstalled verifies that trivy CLI is available in PATH.
func CheckTrivyInstalled() error {
	if err := exec.Command("trivy", "--version").Run(); err != nil {
		return fmt.Errorf("trivy not found: %w. Install from https://trivy.dev", err)
	}
	return nil
}
